pipeline {
  agent any

  environment {
    AWS_DEFAULT_REGION = 'us-west-2'
    CLUSTER_NAME = 'Depii-cluster'
    NAMESPACE = 'default'
  }

  stages {

    stage('Checkout') {
      steps {
        git branch: 'main',
            url: 'https://github.com/BATMAN-G/CI-CD-X.git'
      }
    }

    stage('Deploy to EKS') {
      steps {
        withCredentials([[
          $class: 'AmazonWebServicesCredentialsBinding',
          credentialsId: 'aws-eks-creds'
        ]]) {
          sh '''
            export KUBECONFIG=$WORKSPACE/kubeconfig

            echo "üîß Updating kubeconfig..."
            aws eks update-kubeconfig \
              --region $AWS_DEFAULT_REGION \
              --name $CLUSTER_NAME \
              --kubeconfig $KUBECONFIG

            echo "üöÄ Applying Kubernetes manifests..."
            kubectl apply -f k8s/
          '''
        }
      }
    }

    stage('Get LoadBalancer URL') {
      steps {
        sh '''
          echo "‚è≥ Waiting for LoadBalancer..."

          for i in {1..30}; do
            LB=$(kubectl get svc -n $NAMESPACE \
              --field-selector spec.type=LoadBalancer \
              -o jsonpath='{.items[0].status.loadBalancer.ingress[0].hostname}')

            if [ -n "$LB" ]; then
              echo "‚úÖ LoadBalancer URL:"
              echo "üåê http://$LB"
              exit 0
            fi

            sleep 10
          done

          echo "‚ùå LoadBalancer not ready"
          exit 1
        '''
      }
    }
  }
}
